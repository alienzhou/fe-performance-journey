# å››ã€é¡µé¢è§£æä¸å¤„ç†

[ğŸ”™ ä¸Šä¸€ç«™ - æœåŠ¡ç«¯å“åº”](../3-response/README.md)

åœ¨ä¸Šä¸€ç«™ä¸­ï¼Œæˆ‘ä»¬ç®€å•ä»‹ç»äº†æœåŠ¡ç«¯å¤„ç†ä¸å“åº”ï¼Œåˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬å·²ç»ç»å†äº†å¾ˆå¤šç¯èŠ‚ï¼Œä¹Ÿå·²ç»æœ‰äº†è®¸å¤šã€Œæ€§èƒ½ä¼˜åŒ–çš„æ­¦å™¨ã€ã€‚åƒæ˜¯

- åˆ©ç”¨å„çº§ç¼“å­˜è¿›è¡Œä¼˜åŒ–
- æå‰è¿›è¡Œ DNS æŸ¥è¯¢æˆ–å»ºç«‹è¿æ¥ç­‰æ–¹å¼åŠ é€Ÿè¯·æ±‚
- åœ¨æœåŠ¡ç«¯é¿å…ä¸å¿…è¦çš„è€—æ—¶
- â€¦â€¦

ä¸è¿‡ï¼Œä¸è¦æ‰ä»¥è½»å¿ƒï¼Œåç»­ä»ç„¶æœ‰å¤§é‡çš„å·¥ä½œç­‰å¾…æˆ‘ä»¬æ¥ä¼˜åŒ–ã€‚ä¸‹é¢å°±åˆ°äº†å®¢æˆ·ç«¯æ¥æ”¶å“åº”çš„é˜¶æ®µäº†ã€‚

## ä¸»è¦å·¥ä½œ

è¿™ä¸€é˜¶æ®µæµè§ˆå™¨éœ€è¦å¤„ç†çš„ä¸œè¥¿å¾ˆå¤šï¼Œä¸ºäº†æ›´å¥½åœ°ç†è§£æ€§èƒ½ä¼˜åŒ–ï¼Œæˆ‘ä»¬ä¸»è¦å°†å…¶åˆ†ä¸ºå‡ ä¸ªéƒ¨åˆ†ï¼š

- é¡µé¢ DOM çš„è§£æï¼›
- é¡µé¢é™æ€èµ„æºçš„åŠ è½½ï¼ŒåŒ…æ‹¬äº†é¡µé¢å¼•ç”¨çš„ JavaScript/CSS/å›¾ç‰‡/å­—ä½“ç­‰ï¼›
- é™æ€èµ„æºçš„è§£æä¸å¤„ç†ï¼Œåƒæ˜¯ JavaScript çš„æ‰§è¡Œã€CSSOM çš„æ„å»ºä¸æ ·å¼åˆæˆç­‰ï¼›

å¤§è‡´è¿‡ç¨‹å°±æ˜¯è§£æé¡µé¢ DOM ç»“æ„ï¼Œé‡åˆ°å¤–éƒ¨èµ„æºå°±åŠ è½½ï¼ŒåŠ è½½å¥½äº†å°±ä½¿ç”¨ã€‚ä½†æ˜¯ç”±äºè¿™éƒ¨åˆ†çš„å†…å®¹æ¯”è¾ƒå¤šï¼Œæ‰€ä»¥åœ¨è¿™ä¸€èŠ‚é‡Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨é¡µé¢çš„è§£æï¼ˆå…¶ä»–éƒ¨åˆ†åœ¨å†™ä¸€èŠ‚ä¸­ä»‹ç»ï¼‰ã€‚

## 1. æ³¨æ„èµ„æºåœ¨é¡µé¢æ–‡æ¡£ä¸­çš„ä½ç½®

æˆ‘ä»¬çš„ç›®æ ‡æ˜¯æ”¶åˆ°å†…å®¹å°±å°½å¿«è§£æå¤„ç†ï¼Œé¡µé¢æœ‰ä¾èµ–çš„èµ„æºå°±å°½å¿«å‘é€è¯·æ±‚ï¼Œæ”¶åˆ°å“åº”åˆ™å°½å¿«å¤„ç†ã€‚ç„¶è€Œï¼Œè¿™ä¸ªç¾å¥½çš„ç›®æ ‡ä¹Ÿæœ‰å¯èƒ½ä¼šè¢«æˆ‘ä»¬ä¸å°å¿ƒç ´åã€‚

JavaScript è„šæœ¬å’Œ CSS æ ·å¼è¡¨åœ¨å…³äº DOM å…ƒç´ çš„å±æ€§ï¼Œå°¤å…¶æ˜¯æ ·å¼å±æ€§ä¸Šéƒ½æœ‰æ“ä½œçš„æƒåˆ©ã€‚è¿™å°±åƒæ˜¯ä¸€ä¸ªå¤šçº¿ç¨‹é—®é¢˜ã€‚æœåŠ¡ç«¯å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ç»å¸¸é€šè¿‡é”æ¥ä¿è¯çº¿ç¨‹é—´çš„äº’æ–¥ã€‚å›åˆ°å’±ä»¬çš„å‰ç«¯ï¼Œç°åœ¨ä¹Ÿæ˜¯ä¸¤æ–¹åœ¨ç«äº‰åŒä¸€ä¸ªèµ„æºï¼Œæ˜¾ç„¶ä¹Ÿæ˜¯ä¼šæœ‰äº’æ–¥çš„é—®é¢˜ã€‚è¿™å°±å¸¦æ¥äº† DOM è§£æã€JavaScript åŠ è½½ä¸æ‰§è¡Œã€CSS åŠ è½½ä¸ä½¿ç”¨ä¹‹é—´çš„ä¸€äº›äº’æ–¥å…³ç³»ã€‚

ä»…ä»…çœ‹ DOM ä¸ CSS çš„å…³ç³»ï¼Œåˆ™å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![pipeline for dom and css](./img/pipeline1.png)

HTML è§£æä¸º DOM Treeï¼ŒCSS è§£æä¸º CSSOMï¼Œä¸¤è€…å†åˆæˆ Render Treeï¼Œå¹¶è¡Œæ‰§è¡Œï¼Œéå¸¸å®Œç¾ã€‚ç„¶è€Œï¼Œå½“ JavaScript å…¥åœºä¹‹åï¼Œå±€é¢å°±å˜äº†ï¼š

![pipeline for dom and css with js](./img/pipeline2.png)

æ ¹æ®æ ‡å‡†è§„èŒƒï¼Œåœ¨ JavaScript ä¸­å¯ä»¥è®¿é—® DOMã€‚å› æ­¤å½“é‡åˆ° JavaScript åä¼šé˜»å¡ DOM çš„è§£æã€‚äºæ­¤åŒæ—¶ï¼Œä¸ºé¿å… CSS ä¸ JavaScript ä¹‹é—´çš„ç«æ€ï¼ŒCSSOM çš„æ„å»ºä¼šé˜»å¡ JavaScript çš„è„šæœ¬æ‰§è¡Œã€‚æ€»ç»“èµ·æ¥å°±æ˜¯ â€”â€”

> JavaScript ä¼šé˜»å¡ DOM æ„å»ºï¼Œè€Œ CSSOM çš„æ„å»ºåˆå›é˜»å¡ JavaScript çš„æ‰§è¡Œã€‚

æ‰€ä»¥è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨ä¼˜åŒ–çš„æœ€ä½³å®è·µä¸­ï¼Œæˆ‘ä»¬åŸºæœ¬éƒ½æ¨èæŠŠ CSS æ ·å¼è¡¨æ”¾åœ¨ `<head>` ä¹‹ä¸­ï¼ˆå³é¡µé¢çš„å¤´éƒ¨ï¼‰ï¼ŒæŠŠ JavaScript è„šæœ¬æ”¾åœ¨ `<body>` çš„æœ€åï¼ˆå³é¡µé¢çš„å°¾éƒ¨ï¼‰ã€‚

å…³äºè¿™éƒ¨åˆ†çš„ä¸€äº›è§£é‡Šå¯ä»¥çœ‹[è¿™ç¯‡æ–‡ç« ](https://calendar.perfplanet.com/2012/deciphering-the-critical-rendering-path/)<sup>[1]</sup>ã€‚

## 2. ä½¿ç”¨ defer å’Œ async

ä¸Šé¢æåˆ°äº†ï¼Œå½“ DOM è§£æé‡åˆ° JavaScript è„šæœ¬æ—¶ï¼Œä¼šåœæ­¢è§£æï¼Œå¼€å§‹ä¸‹è½½è„šæœ¬å¹¶æ‰§è¡Œï¼Œå†æ¢å¤è§£æï¼Œç›¸å½“äºæ˜¯é˜»å¡äº† DOM æ„å»ºã€‚

é‚£é™¤äº†å°†è„šæœ¬æ”¾åœ¨ `body` çš„æœ€åï¼Œè¿˜æœ‰ä»€ä¹ˆä¼˜åŒ–æ–¹æ³•ä¹ˆï¼Ÿæ˜¯æœ‰çš„ã€‚

å¯ä»¥ä½¿ç”¨ `defer` æˆ– `async` å±æ€§ã€‚ä¸¤è€…éƒ½ä¼šé˜²æ­¢ JavaScript è„šæœ¬çš„ä¸‹è½½é˜»å¡ DOM æ„å»ºã€‚ä½†æ˜¯ä¸¤è€…ä¹Ÿæœ‰åŒºåˆ«ï¼Œæœ€ç›´è§‚çš„è¡¨ç°å¦‚ä¸‹ï¼š

![async defer](./img/async-defer.jpeg)

`defer` ä¼šåœ¨ HTML è§£æå®Œæˆåï¼ŒæŒ‰ç…§è„šæœ¬å‡ºç°çš„æ¬¡åºå†é¡ºåºæ‰§è¡Œï¼›è€Œ `async` åˆ™æ˜¯ä¸‹è½½å®Œæˆå°±ç«‹å³å¼€å§‹æ‰§è¡Œï¼ŒåŒæ—¶é˜»å¡é¡µé¢è§£æï¼Œä¸ä¿è¯è„šæœ¬é—´çš„æ‰§è¡Œé¡ºåºã€‚

æ ¹æ®å®ƒä»¬çš„ç‰¹ç‚¹ï¼Œæ¨èåœ¨ä¸€äº›ä¸ä¸»ä¸šåŠ¡æ— å…³çš„ JavaScript è„šæœ¬ä¸Šä½¿ç”¨ asyncã€‚ä¾‹å¦‚ç»Ÿè®¡è„šæœ¬ã€ç›‘æ§è„šæœ¬ã€å¹¿å‘Šè„šæœ¬ç­‰ã€‚è¿™äº›è„šæœ¬ä¸€èˆ¬éƒ½æ˜¯ä¸€ä»½ç‹¬ç«‹çš„æ–‡ä»¶ï¼Œæ²¡æœ‰å¤–éƒ¨ä¾èµ–ï¼Œä¸éœ€è¦è®¿é—® DOMï¼Œä¹Ÿä¸éœ€è¦æœ‰ä¸¥æ ¼çš„æ‰§è¡Œæ—¶æœºé™åˆ¶ã€‚åœ¨è¿™äº›è„šæœ¬ä¸Šä½¿ç”¨ `async` å¯ä»¥æœ‰æ•ˆé¿å…è¿™äº›éæ ¸å¿ƒåŠŸèƒ½çš„åŠ è½½å½±å“é¡µé¢è§£æé€Ÿåº¦ã€‚

## 3. é¡µé¢æ–‡æ¡£å‹ç¼©

HTML çš„æ–‡æ¡£å¤§å°ä¹Ÿä¼šæå¤§å½±å“å“åº”ä½“ä¸‹è½½çš„æ—¶é—´ã€‚ä¸€èˆ¬ä¼šè¿›è¡Œ HTML å†…å®¹å‹ç¼©ï¼ˆuglifyï¼‰çš„åŒæ—¶ï¼Œä½¿ç”¨æ–‡æœ¬å‹ç¼©ç®—æ³•ï¼ˆä¾‹å¦‚ gzipï¼‰è¿›è¡Œæ–‡æœ¬çš„å‹ç¼©ã€‚å…³äºèµ„æºå‹ç¼©è¿™ä¸€å—ï¼Œåœ¨ä¸‹ä¸€èŠ‚çš„å†…å®¹ä¸­è¿˜ä¼šå†è¯¦ç»†è¿›è¡Œä»‹ç»ã€‚

---

è¯´ä¸€å¥é¢˜å¤–è¯ï¼Œä½ çŸ¥é“ä¸é¡µé¢è§£æå¯†åˆ‡ç›¸å…³çš„ DOMContentLoaded äº‹ä»¶ä½•æ—¶è§¦å‘ä¹ˆï¼Ÿinteractive/complete ç­‰ readyState å…·ä½“ä»£è¡¨ä»€ä¹ˆä¹ˆï¼Ÿå¦‚æœä¸å¤ªäº†è§£å¯ä»¥ä»[HTML spec](https://html.spec.whatwg.org/multipage/dom.html#current-document-readiness)<sup>[2]</sup>é‡Œçœ‹ã€‚

ç”¨åŸè¯æ¥è¯´å°±æ˜¯ï¼š

> Returns "loading" while the Document is loading, "interactive" once it is finished parsing but still loading subresources, and "complete" once it has loaded.

> The readystatechange event fires on the Document object when this value changes.

> The DOMContentLoaded event fires after the transition to "interactive" but before the transition to "complete", at the point where all subresources apart from async script elements have loaded.

---

å¥½äº†ï¼Œåœ¨è¿™ä¸€ç«™æˆ‘ä»¬åˆäº†è§£äº†é¡µé¢çš„è§£æè¿‡ç¨‹åŠå…¶æ€§èƒ½ä¼˜åŒ–ã€‚

æ­£å¦‚å¼€å¤´æ‰€è¯´ï¼Œå…¶å®è§£æé¡µé¢ã€åŠ è½½èµ„æºã€ä½¿ç”¨èµ„æºæ˜¯ä¸‰ä¸ªç´§å¯†ç›¸å…³çš„è¿‡ç¨‹ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬ä¸»è¦ç€çœ¼äºé¡µé¢çš„è§£æï¼Œè€Œåœ¨ã€Œå‰ç«¯æ€§èƒ½ä¼˜åŒ–ä¹‹æ—…ã€çš„ä¸‹ä¸€ç«™ï¼Œæˆ‘ä»¬åˆ™ä¼šä¸€èµ·æ¥æ¶‰è¶³åˆ°è¿™éƒ¨åˆ†çš„å…¶ä»–è¯¸å¤šä¼˜åŒ–ç‚¹ä¸­ã€‚

[ä¸‹ä¸€ç«™ - é¡µé¢é™æ€èµ„æº ğŸ”œ](../5-subresources/README.md)

---

## å‚è€ƒèµ„æ–™

1. [Deciphering the Critical Rendering Path](https://calendar.perfplanet.com/2012/deciphering-the-critical-rendering-path/)
1. [HTML5 spec: current-document-readiness](https://html.spec.whatwg.org/multipage/dom.html#current-document-readiness)
1. [Async Defer â€” JavaScript Loading Strategies](https://medium.com/@raviroshan.talk/async-defer-javascript-loading-strategies-da489a0ba47e)
1. [Speed up Google Maps(and everything else) with async & defer](https://medium.com/@nikjohn/speed-up-google-maps-and-everything-else-with-async-defer-7b9814efb2b)
1. [HTML5 spec: parse HTML (the end)](https://html.spec.whatwg.org/multipage/parsing.html#the-end)
