# é¡µé¢è§£æä¸å¤„ç†

[ğŸ”™ ä¸Šä¸€ç«™ - æœåŠ¡ç«¯å“åº”](../3-response/README.md)

æˆ‘ä»¬å·²ç»åˆ°äº†æ¥æ”¶å“åº”çš„é˜¶æ®µäº†ã€‚

ä»æˆ‘ä»¬åœ¨åœ°å€æ è¾“å…¥ä¸€ä¸ª URL æŒ‰ä¸‹å›è½¦ï¼Œåˆ°ç°åœ¨ä¼¼ä¹å·²ç»ç»å†äº†å¾ˆå¤šã€‚å…¶é—´æˆ‘ä»¬é€šè¿‡

- åˆ©ç”¨å„çº§ç¼“å­˜è¿›è¡Œä¼˜åŒ–
- æå‰è¿›è¡Œ DNS æŸ¥è¯¢æˆ–å»ºç«‹è¿æ¥ç­‰æ–¹å¼åŠ é€Ÿè¯·æ±‚
- åœ¨æœåŠ¡ç«¯é¿å…ä¸å¿…è¦çš„è€—æ—¶

è¿™äº›æ‰‹æ®µæ¥é™ä½è·å–å“åº”çš„é¦–å­—èŠ‚è€—æ—¶ã€‚ç›®å‰ï¼Œæˆ‘ä»¬çš„ä»“åº“é‡Œå·²ç»æœ‰äº†è®¸å¤šã€Œæ€§èƒ½ä¼˜åŒ–çš„æ­¦å™¨ã€ï¼›ä¸è¿‡ï¼Œä¸è¦æ‰ä»¥è½»å¿ƒï¼Œåç»­ä»ç„¶æœ‰å¤§é‡çš„å·¥ä½œç­‰å¾…æˆ‘ä»¬æ¥ä¼˜åŒ–ã€‚

## ä¸»è¦å·¥ä½œ

å½“å‰é˜¶æ®µæµè§ˆå™¨éœ€è¦å¤„ç†çš„é—®é¢˜å¾ˆå¤šï¼Œä¸ºäº†æ›´å¥½ç†è§£æ€§èƒ½ä¼˜åŒ–ä¹‹æ—…çš„å†…å®¹ï¼Œæˆ‘ä»¬ä¸»è¦å°†å…¶åˆ†ä¸ºå‡ ä¸ªéƒ¨åˆ†ï¼š

- é¡µé¢ DOM çš„è§£æï¼›
- é¡µé¢å­èµ„æºçš„åŠ è½½ï¼ŒåŒ…æ‹¬äº†é¡µé¢å¼•ç”¨çš„ JavaScript/CSS/Image/Fonts ç­‰ç­‰ï¼›
- å­èµ„æºçš„è§£æä¸å¤„ç†ï¼ŒåŒ…æ‹¬ JavaScript çš„æ‰§è¡Œï¼ŒCSSOM çš„æ„å»ºä¸æ ·å¼åˆæˆç­‰ï¼›

å¤§è‡´å°±æ˜¯è§£æé¡µé¢ DOM ç»“æ„ï¼Œé‡åˆ°å¤–éƒ¨ï¼ˆå­ï¼‰èµ„æºå°±åŠ è½½ï¼ŒåŠ è½½å¥½äº†å°±ä½¿ç”¨ã€‚ç”±äºè¿™éƒ¨åˆ†çš„å†…å®¹æ¯”è¾ƒå¤šï¼Œæ‰€ä»¥åœ¨è¿™ä¸€èŠ‚é‡Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨é¡µé¢çš„è§£æã€‚

## 1. æ³¨æ„èµ„æºåœ¨é¡µé¢æ–‡æ¡£ä¸­çš„ä½ç½®

åŸºäºå‰ä¸€èŠ‚æåˆ°çš„æµå¼å“åº”ï¼Œæˆ‘ä»¬çš„ç›®æ ‡è‚¯å®šæ˜¯æ”¶åˆ°å†…å®¹å°±å°½å¿«è§£æå¤„ç†ï¼Œæœ‰å­èµ„æºçš„è¯·æ±‚å°±å°½å¿«å‘é€ï¼Œæ”¶åˆ°å“åº”åˆ™å°½å¿«å¤„ç†ã€‚ç„¶è€Œï¼Œè¿™ä¸ªç¾å¥½çš„ç›®æ ‡ä¹Ÿæœ‰å¯èƒ½ä¼šè¢«æˆ‘ä»¬ä¸å°å¿ƒç ´åã€‚

JavaScript è„šæœ¬å’Œ CSS æ ·å¼è¡¨åœ¨å…³äº DOM å…ƒç´ çš„å±æ€§ï¼Œå°¤å…¶æ˜¯æ ·å¼å±æ€§ä¸Šéƒ½æœ‰æ“ä½œçš„æƒåˆ©ã€‚è¿™å°±åƒæ˜¯åç«¯ä¼šç¢°åˆ°çš„å¤šçº¿ç¨‹é—®é¢˜ï¼šå¦‚ä½•ä¿è¯æŸä¸€æ•°æ®æ˜¯çº¿ç¨‹å®‰å…¨ã€‚å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ç»å¸¸é€šè¿‡é”æ¥ä¿è¯çº¿ç¨‹é—´çš„äº’æ–¥ã€‚å›åˆ°å’±ä»¬çš„å‰ç«¯ï¼Œç°åœ¨ä¹Ÿæ˜¯ä¸¤æ–¹åœ¨ç«äº‰ç»Ÿä¸€èµ„æºï¼Œæ˜¾ç„¶ä¹Ÿæ˜¯ä¼šæœ‰äº’æ–¥çš„é—®é¢˜ã€‚

è¿™å°±å¸¦æ¥äº† DOM è§£æã€JavaScript åŠ è½½ä¸æ‰§è¡Œã€CSS åŠ è½½ä¸ä½¿ç”¨ä¹‹é—´çš„ä¸€äº›äº’æ–¥å…³ç³»ã€‚

ä»…ä»…çœ‹ DOM ä¸ CSS çš„å…³ç³»ï¼Œåˆ™å…¥ä¸‹å›¾æ‰€ç¤º

![pipeline for dom and css](./img/pipeline1.png)

HTML è§£æä¸º DOM Treeï¼ŒCSS è§£æä¸º CSSOMï¼Œä¸¤è€…å†åˆæˆ Render Treeï¼Œå¹¶è¡Œæ‰§è¡Œï¼Œéå¸¸å®Œç¾ã€‚ç„¶è€Œï¼Œå½“ JavaScript å…¥åœºä¹‹åï¼Œå±€é¢å°±å˜äº†

![pipeline for dom and css with js](./img/pipeline2.png)

æ ¹æ®æ ‡å‡†è§„èŒƒï¼Œåœ¨ JavaScript ä¸­å¯ä»¥è®¿é—® DOMã€‚å› æ­¤å½“é‡åˆ° JavaScript åä¼šé˜»å¡ DOM çš„è§£æã€‚äºæ­¤åŒæ—¶ï¼Œä¸ºé¿å… CSS ä¸ JavaScript ä¹‹é—´çš„ç«æ€ï¼ŒCSSOM çš„æ„å»ºä¼šé˜»å¡ JavaScript çš„è„šæœ¬æ‰§è¡Œã€‚æ€»ç»“èµ·æ¥å°±æ˜¯ â€”â€”

> JavaScript åä¼šé˜»å¡ DOM æ„å»ºï¼Œè€Œ CSSOM çš„æ„å»ºåˆå›é˜»å¡ JavaScript çš„æ‰§è¡Œã€‚

æ‰€ä»¥è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨ä¼˜åŒ–çš„æœ€ä½³å®è·µä¸­ï¼Œæˆ‘ä»¬åŸºæœ¬éƒ½æ¨èæŠŠ CSS æ ·å¼è¡¨æˆ–è€… style æ ‡ç­¾æ”¾åœ¨ `head` ä¹‹ä¸­ï¼ˆå³é¡µé¢çš„å¤´éƒ¨ï¼‰ï¼ŒæŠŠ JavaScript è„šæœ¬æ”¾åœ¨ `body` çš„æœ€åï¼ˆå³é¡µé¢çš„å°¾éƒ¨ï¼‰ã€‚

å…³äºè¿™éƒ¨åˆ†çš„ä¸€äº›è§£é‡Šå¯ä»¥çœ‹[è¿™ç¯‡æ–‡ç« ](https://calendar.perfplanet.com/2012/deciphering-the-critical-rendering-path/)<sup>[1]</sup>ã€‚

## 2. ä½¿ç”¨ defer å’Œ async

ä¸Šé¢æåˆ°äº†ï¼Œåœ¨ DOM è§£æé‡åˆ° JavaScript è„šæœ¬æ—¶ï¼Œä¼šåœæ­¢è§£æï¼Œå¼€å§‹ä¸‹è½½è„šæœ¬å¹¶æ‰§è¡Œï¼Œå†æ¢å¤è§£æï¼Œç›¸å½“äºæ˜¯é˜»å¡äº† DOM æ„å»ºã€‚

é‚£é™¤äº†å°†è„šæœ¬æ”¾åœ¨ `body` çš„æœ€åï¼Œè¿˜æœ‰ä»€ä¹ˆä¼˜åŒ–æ–¹æ³•ä¹ˆï¼Ÿå…¶å®æ˜¯æœ‰çš„ã€‚

å¯ä»¥ä½¿ç”¨ defer æˆ– async å±æ€§ï¼Œä¸¤è€…éƒ½ä¼šé˜²æ­¢ DOM æ„å»ºé˜»å¡åœ¨ JavaScript è„šæœ¬ä¸‹è½½ä¸Šã€‚ä½†æ˜¯ä¸¤è€…ä¹Ÿæœ‰åŒºåˆ«ï¼Œæœ€ç›´è§‚çš„è¡¨ç°å°±æ˜¯

![async defer](./img/async-defer.jpeg)

å¯è§ï¼Œdefer ä¼šåœ¨ HTML è§£æå®Œæˆåï¼ŒæŒ‰ç…§è„šæœ¬å‡ºç°çš„æ¬¡åºå†é¡ºåºæ‰§è¡Œï¼›è€Œ async åˆ™æ˜¯ä¸‹å®Œå®Œæˆå°±ç«‹å³å¼€å§‹æ‰§è¡Œï¼ŒåŒæ—¶é˜»å¡é¡µé¢è§£æï¼Œä¸ä¿è¯ç®€æœ¬é—´çš„æ‰§è¡Œé¡ºåºã€‚

æ ¹æ®å®ƒä»¬çš„ç‰¹ç‚¹ï¼Œéå¸¸æ¨èåœ¨ä¸€äº›ä¸ä¸»ä¸šåŠ¡æ— å…³çš„ JavaScript è„šæœ¬ä¸Šä½¿ç”¨ asyncã€‚ä¾‹å¦‚ç»Ÿè®¡è„šæœ¬ã€ç›‘æ§è„šæœ¬ã€å¹¿å‘Šè„šæœ¬ç­‰ã€‚è¿™äº›è„šæœ¬ä¸€èˆ¬éƒ½æ˜¯ä¸€ä»½ç‹¬ç«‹çš„æ–‡ä»¶ï¼Œæ²¡æœ‰å¤–éƒ¨ä¾èµ–ï¼Œä¸éœ€è¦è®¿é—® DOMï¼ŒåŒæ—¶ä¹Ÿä¸éœ€è¦æœ‰ä¸¥æ ¼çš„æ‰§è¡Œæ—¶æœºé™åˆ¶ã€‚è¿™æ ·ä½¿ç”¨å¯ä»¥æœ‰æ•ˆé¿å…è¿™äº›éæ ¸å¿ƒåŠŸèƒ½çš„åŠ è½½å½±å“é¡µé¢è§£æé€Ÿåº¦ã€‚

---

è¯´ä¸€å¥é¢˜å¤–è¯ï¼Œä½ çŸ¥é“ä¸é¡µé¢è§£æå¯†åˆ‡ç›¸å…³çš„ DOMContentLoaded äº‹ä»¶ä½•æ—¶è§¦å‘ä¹ˆï¼Ÿä½ çŸ¥é“ interactive/complete ç­‰ readyState å…·ä½“ä»£è¡¨ä»€ä¹ˆä¹ˆï¼Ÿå¦‚æœä¸å¤ªäº†è§£å¯ä»¥ä»[HTML spec](https://html.spec.whatwg.org/multipage/dom.html#current-document-readiness)<sup>[2]</sup>é‡Œçœ‹ã€‚

ç”¨åŸè¯æ¥è¯´å°±æ˜¯ï¼š

> Returns "loading" while the Document is loading, "interactive" once it is finished parsing but still loading subresources, and "complete" once it has loaded.

> The readystatechange event fires on the Document object when this value changes.

> The DOMContentLoaded event fires after the transition to "interactive" but before the transition to "complete", at the point where all subresources apart from async script elements have loaded.

---

å¥½äº†ï¼Œåœ¨æ—…é€”ä¸­çš„è¿™ä¸€èŠ‚æˆ‘ä»¬åˆçŸ¥é“äº†å¦‚ä½•åœ¨é¡µé¢è§£æè¿‡ç¨‹ä¸­è¿›è¡Œæ€§èƒ½ä¼˜åŒ–ã€‚

æ­£å¦‚å¼€å¤´æ‰€è¯´ï¼Œå…¶å®è§£æé¡µé¢ã€åŠ è½½èµ„æºã€ä½¿ç”¨èµ„æºæ˜¯ä¸‰ä¸ªç´§å¯†ç›¸å…³çš„è¿‡ç¨‹ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬ä¸»è¦ç€çœ¼äºé¡µé¢çš„è§£æï¼Œè€Œåœ¨ã€Œæ€§èƒ½ä¹‹æ—…ã€çš„ä¸‹ä¸€ç«™ï¼Œæˆ‘ä»¬åˆ™ä¼šä¸€èµ·æ¥æ¶‰åŠè¿™éƒ¨åˆ†çš„å…¶ä»–è¯¸å¤šä¼˜åŒ–ç‚¹ã€‚

[ä¸‹ä¸€ç«™ - é¡µé¢é™æ€èµ„æº ğŸ”œ](../5-subresources/README.md)

---

## æ‹“å±•é˜…è¯»

1. [Deciphering the Critical Rendering Path](https://calendar.perfplanet.com/2012/deciphering-the-critical-rendering-path/)
1. [HTML5 spec: current-document-readiness](https://html.spec.whatwg.org/multipage/dom.html#current-document-readiness)
1. [Async Defer â€” JavaScript Loading Strategies](https://medium.com/@raviroshan.talk/async-defer-javascript-loading-strategies-da489a0ba47e)
1. [Speed up Google Maps(and everything else) with async & defer](https://medium.com/@nikjohn/speed-up-google-maps-and-everything-else-with-async-defer-7b9814efb2b)
1. [HTML5 spec: parse HTML (the end)](https://html.spec.whatwg.org/multipage/parsing.html#the-end)
